<!DOCTYPE html>
<html lang="en">
  <head>
    <style>
      body {
        margin: 0;
      }

      .test {
        display: block;
        position: fixed;
        z-index: 200;
        padding: 20px;
        font-size: 40px;
        font-family: "Trebuchet MS", sans-serif;
      }

      .Pcultural {
        color: rgb(128, 189, 255);
      }
      .Pnatural {
        color: rgb(42, 245, 48);
      }
      .Pmixed {
        color: rgb(246, 250, 32);
      }

      .bottom-text {
        font-family: Arial, Helvetica, sans-serif;
        font-size: 40px;
        position: fixed;
        bottom: 50px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(255, 255, 255, 0.445);
        padding: 10px;
        border-radius: 9px;
        color: white;
        display: inline-block;
      }
      .dropdown-container {
        top: 15px;
        left: 50%;
        transform: translateX(-50%);
        position: fixed;
        z-index: 200;
        padding: 0px;
        font-family: Arial, Helvetica, sans-serif;
      }

      #sitesDropdown {
        font-size: 12px;
        padding: 12px;
        background-color: rgba(255, 255, 255, 0.562);
        border-radius: 10px;
        border: none;
      }
    </style>
    <script src="//unpkg.com/globe.gl"></script>
  </head>
  <body>
    <div class="test">
      <p onclick="culturalClick()" class="Pcultural">• Cultural</p>
      <p onclick="naturalClick()" class="Pnatural">• Natural</p>
      <p onclick="mixedClick()" class="Pmixed">• Mixed</p>
      <!--Barre de recherche de pays-->
      <input
        type="text"
        placeholder="Rechercher un pays.."
        id="countrySearch"
      />
      <button onclick="goToCountry()">Aller au pays</button>
    </div>

    <div class="dropdown-container">
      <select id="sitesDropdown"></select>
    </div>
    <div id="globeViz"></div>

    <div class="bottom-text" id="bottomText">
      <a id="labelLink" href="#" target="_blank"></a>
    </div>

    <script>
      let category;
      let i;
      let globeInstance; // Declare globeInstance in the global scope

      let bottomText = document.getElementById("bottomText");

      // Fichier json contenant toutes les infos
      fetch("datasets/real_planet_unesco.json")
        .then((res) => res.json())
        .then((places) => {
          // Initialisation globe
          globeInstance = Globe()
            .globeImageUrl("./src/img/betterquality.png")
            .backgroundImageUrl(
              "//unpkg.com/three-globe/example/img/night-sky.png"
            )
            .labelsData(places)
            .labelLat((d) => d.latitude)
            .labelLng((d) => d.longitude)
            .labelText((d) => d.name_en)
            .labelSize(0)
            .labelDotRadius(0.1)
            .labelColor((d) => {
              if (d.category == "Cultural") {
                return "rgb(128, 189, 255)";
              } else if (d.category == "Natural") {
                return "rgb(42, 245, 48)";
              } else if (d.category == "Mixed") {
                return "rgb(246, 250, 32)";
              }
            })
            .labelResolution(2)(document.getElementById("globeViz"));

          globeInstance.onLabelHover((label, prevLabel) => {
            if (label) {
              bottomText.innerText = `${label.name_en}`;
            } else {
              bottomText.innerText = "";
            }
          });

          globeInstance.onLabelClick((label, event, coords) => {
            window.open(label.link, "_blank");
          });

          //Point de vue par défaut (centré sur l'europe)
          globeInstance.pointOfView({ lat: 47, lng: 18, altitude: 0.8 });
        });

      // Chargez le fichier JSON des sites UNESCO
      fetch("datasets/real_planet_unesco.json")
        .then((response) => response.json())
        .then((sitesData) => {
          // Récupérez l'élément dropdown
          const dropdown = document.getElementById("sitesDropdown");

          // Créez un objet pour stocker les sites par pays
          const sitesByCountry = {};

          // Bouclez sur les données des sites UNESCO
          sitesData.forEach((site) => {
            // Vérifiez si le pays existe dans l'objet
            if (!sitesByCountry[site.states_name_en]) {
              sitesByCountry[site.states_name_en] = [];
            }

            // Ajoutez le site au tableau correspondant au pays
            sitesByCountry[site.states_name_en].push(site);
          });

          // Bouclez sur les pays et créez les groupes et options
          for (const country in sitesByCountry) {
            if (sitesByCountry.hasOwnProperty(country)) {
              // Créez un groupe d'options pour chaque pays
              const optgroup = document.createElement("optgroup");
              optgroup.label = country;

              // Ajoutez les options pour chaque site du pays
              sitesByCountry[country].forEach((site) => {
                const option = document.createElement("option");
                option.value = site.name_en;
                option.text = site.name_en;
                optgroup.appendChild(option);
              });

              // Ajoutez le groupe d'options au dropdown
              dropdown.appendChild(optgroup);
            }
          }
        })
        .catch((error) =>
          console.error("Erreur lors du chargement des sites UNESCO :", error)
        );

      document
        .getElementById("sitesDropdown")
        .addEventListener("change", function () {
          zoomToSelectedSite(this.value); // Appelle la fonction pour zoomer sur le site sélectionné
        });

      function zoomToSelectedSite(selectedSite) {
        fetch("datasets/real_planet_unesco.json")
          .then((res) => res.json())
          .then((places) => {
            const selectedSiteData = places.find(
              (site) => site.name_en === selectedSite
            );

            if (selectedSiteData) {
              globeInstance.pointOfView(
                {
                  lat: selectedSiteData.latitude,
                  lng: selectedSiteData.longitude,
                  altitude: 0.3,
                },
                3000
              );
            } else {
              console.log("Site non trouvé dans le JSON.");
            }
          });
      }

      function goToCountry() {
        var inputCountry = document.getElementById("countrySearch").value;
        fetch("datasets/countries-positions.json")
          .then((response) => response.json())
          .then((jsonData) => {
            if (jsonData && jsonData.ref_country_codes) {
              var countryData = jsonData.ref_country_codes.find(function (
                country
              ) {
                return (
                  country.country.toLowerCase() === inputCountry.toLowerCase()
                );
              });

              if (countryData) {
                globeInstance.pointOfView(
                  {
                    lat: countryData.latitude,
                    lng: countryData.longitude,
                    altitude: 2,
                  },
                  3000
                );

                // Delay for 3000 milliseconds (3 seconds) before zooming in
                setTimeout(() => {
                  // Zoom in
                  globeInstance.pointOfView(
                    {
                      lat: countryData.latitude,
                      lng: countryData.longitude,
                      altitude: 0.3,
                    },
                    3000
                  );
                }, 3000);
              } else {
                console.log("Pays non trouvé dans le JSON.");
              }
            }
          });
      }
    </script>
  </body>
</html>
